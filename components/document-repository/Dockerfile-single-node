# Use Node.js 22.14.0 as the base image
FROM node:22.14.0


# Install system dependencies required for clamscan and other packages
RUN apt-get update && \
    apt-get install -y clamav clamav-daemon && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Configure freshclam to not notify clamd during initial update
RUN sed -i 's/^NotifyClamd/#NotifyClamd/' /etc/clamav/freshclam.conf

# Update clamd.conf to use TCP instead of socket
RUN sed -i 's/^LocalSocket /#LocalSocket /' /etc/clamav/clamd.conf \
    && sed -i 's/^FixStaleSocket /#FixStaleSocket /' /etc/clamav/clamd.conf \
    && sed -i 's/^LocalSocketGroup /#LocalSocketGroup /' /etc/clamav/clamd.conf \
    && sed -i 's/^LocalSocketMode /#LocalSocketMode /' /etc/clamav/clamd.conf \
    && echo 'TCPSocket 3310' >> /etc/clamav/clamd.conf \
    && echo 'TCPAddr 0.0.0.0' >> /etc/clamav/clamd.conf

# Create app directory
WORKDIR /app

# Copy startup script
COPY document-repository/scripts/clamav-node.sh ./ 
RUN chmod +x clamav-node.sh

# Copy package files
COPY document-repository/package*.json ./

# Install app dependencies
RUN npm config set registry https://registry.npmjs.org/ && \
    npm install --verbose --fetch-timeout 600000 || \
    npm install --prefer-offline || \
    npm ci
RUN ls -la /app/node_modules | head -n 20  # List first 20 items in node_modules (should include 'dotenv')
RUN npm list dotenv  # Confirm dotenv is installed

# Copy app source
COPY document-repository/src/ ./src/

# Copy shared-lib with all contents\
RUN rm -rf /app/src/shared-lib/*
COPY shared/lib/ /app/src/shared-lib/

# Create directories for uploads and logs
RUN mkdir -p uploads logs

# Debug: List contents of directories
RUN ls -la /app && \
    ls -la /app/src/shared-lib
RUN [ -f /app/src/shared-lib/logger.js ] || { echo "logger.js missing!"; exit 1; }
RUN [ -f /app/src/shared-lib/db-connection-service.js ] || { echo "db-connection-service.js missing!"; exit 1; }

# Expose the port the app runs on
EXPOSE 3001 3310

# Set environment variables
ARG ARANGO_PASSWORD
ENV NODE_ENV=development
ENV PORT=3001
ENV ARANGO_URL=http://arango-vector-db:8529
ENV ARANGO_DB=node-services
ENV ARANGO_USER=root
ENV ARANGO_PASSWORD=$ARANGO_PASSWORD
ENV UPLOAD_DIR=./uploads
ENV MAX_FILE_SIZE=524288000
ENV MAX_FILES_UPLOAD=10

# Start the application
CMD ["bash", "/app/clamav-node.sh"]
